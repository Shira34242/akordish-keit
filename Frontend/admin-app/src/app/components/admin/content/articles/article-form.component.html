<div class="form-container">
  <!-- Header -->
  <div class="form-header">
    <button class="btn-back" (click)="goBack()">
      ← חזרה לרשימה
    </button>
    <h1 class="form-title">
      {{ isEditMode ? 'עריכת כתבה' : 'כתבה חדשה' }}
    </h1>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>טוען...</p>
  </div>

  <!-- Form -->
  <form *ngIf="!loading" (ngSubmit)="onSubmit()" class="article-form">

    <!-- Basic Information Section -->
    <div class="form-section">
      <h2 class="section-title">מידע בסיסי</h2>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label required">כותרת</label>
          <input type="text" class="form-input" [(ngModel)]="article.title" name="title" (input)="onTitleChange()"
            placeholder="הזן כותרת..." required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">כותרת משנה</label>
          <input type="text" class="form-input" [(ngModel)]="article.subtitle" name="subtitle"
            placeholder="כותרת משנה (אופציונלי)">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label required">תוכן הכתבה</label>
          <textarea class="form-textarea" [(ngModel)]="article.content" name="content" (input)="calculateReadTime()"
            rows="15" placeholder="תוכן הכתבה..." required></textarea>
          <div class="field-hint" *ngIf="article.readTimeMinutes">
            זמן קריאה משוער: {{ article.readTimeMinutes }} דקות
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">תקציר קצר</label>
          <textarea class="form-textarea" [(ngModel)]="article.shortDescription" name="shortDescription" rows="3"
            placeholder="תיאור קצר שיוצג ברשימות..." maxlength="1000"></textarea>
        </div>
      </div>
    </div>

    <!-- Classification Section -->
    <div class="form-section">
      <h2 class="section-title">סיווג</h2>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label required">סוג תוכן</label>
          <select class="form-select" [(ngModel)]="article.contentType" name="contentType" required>
            <option [ngValue]="ArticleContentType.News">חדשות</option>
            <option [ngValue]="ArticleContentType.Blog">בלוג</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required">
            קטגוריות
            <span class="selected-count" *ngIf="article.categoryIds.length > 0">
              (נבחרו {{ article.categoryIds.length }})
            </span>
          </label>

          <div class="categories-checkboxes" [class.collapsed]="!categoriesExpanded">
            <label *ngFor="let cat of getVisibleCategories()" class="category-checkbox">
              <input
                type="checkbox"
                [checked]="isCategorySelected(cat.id)"
                (change)="toggleCategory(cat.id)"
                [name]="'category-' + cat.id">
              <span>{{ cat.name }}</span>
            </label>
          </div>

          <button
            *ngIf="hasMoreCategories"
            type="button"
            class="btn-toggle-categories"
            (click)="toggleCategoriesExpanded()">
            <span class="material-icons">{{ categoriesExpanded ? 'expand_less' : 'expand_more' }}</span>
            {{ categoriesExpanded ? 'הצג פחות' : 'הצג עוד' }} ({{ categories.length }} קטגוריות)
          </button>

          <div class="field-hint" *ngIf="article.categoryIds.length === 0" style="color: red; margin-top: 8px;">
            יש לבחור לפחות קטגוריה אחת
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">שם המחבר</label>
          <input type="text" class="form-input" [(ngModel)]="article.authorName" name="authorName"
            placeholder="שם הכותב...">
        </div>
      </div>

      <!-- Tagged Artists -->
      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">
            אמנים מתוייגים
            <span class="selected-count" *ngIf="article.artistIds && article.artistIds.length > 0">
              (נבחרו {{ article.artistIds.length }})
            </span>
          </label>

          <div class="categories-checkboxes" [class.collapsed]="!artistsExpanded">
            <label *ngFor="let artist of getVisibleArtists()" class="category-checkbox">
              <input
                type="checkbox"
                [checked]="isArtistSelected(artist.id)"
                (change)="toggleArtist(artist.id)"
                [name]="'artist-' + artist.id">
              <span>{{ artist.name }}</span>
            </label>
          </div>

          <button
            *ngIf="hasMoreArtists"
            type="button"
            class="btn-toggle-categories"
            (click)="toggleArtistsExpanded()">
            <span class="material-icons">{{ artistsExpanded ? 'expand_less' : 'expand_more' }}</span>
            {{ artistsExpanded ? 'הצג פחות' : 'הצג עוד' }} ({{ artists.length }} אמנים)
          </button>

          <div class="field-hint" style="margin-top: 8px;">
            תייג אמנים הקשורים לכתבה זו. הכתבה תופיע בדף האמן.
          </div>
        </div>
      </div>
    </div>

    <!-- Media Section -->
    <div class="form-section">
      <h2 class="section-title">מדיה</h2>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">תמונת קאבר (URL)</label>
          <input type="url" class="form-input" [(ngModel)]="article.featuredImageUrl" name="featuredImageUrl"
            placeholder="https://...">
          <div class="image-preview" *ngIf="article.featuredImageUrl">
            <img [src]="article.featuredImageUrl" alt="Preview">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">קרדיט צילום</label>
          <input type="text" class="form-input" [(ngModel)]="article.imageCredit" name="imageCredit"
            placeholder="צלם/מקור התמונה...">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">וידאו (Embed URL)</label>
          <div class="input-with-button">
            <input type="url" class="form-input" [(ngModel)]="article.videoEmbedUrl" name="videoEmbedUrl"
              (blur)="onVideoUrlChange()" placeholder="https://youtube.com/embed/...">
            <button type="button" class="btn-fetch-youtube" (click)="fetchYouTubeThumbnail()"
              [disabled]="!article.videoEmbedUrl || fetchingYouTube" title="שלוף תמונה מיוטיוב">
              <span *ngIf="!fetchingYouTube" class="material-icons">image</span>
              <span *ngIf="fetchingYouTube" class="spinner-small"></span>
            </button>
          </div>
          <small class="help-text" *ngIf="youtubeMessage">{{ youtubeMessage }}</small>
        </div>

        <div class="form-group">
          <label class="form-label">אודיו (Embed URL)</label>
          <input type="url" class="form-input" [(ngModel)]="article.audioEmbedUrl" name="audioEmbedUrl"
            placeholder="https://spotify.com/embed/...">
        </div>
      </div>
    </div>

    <!-- Gallery Section -->
    <div class="form-section">
      <h2 class="section-title">גלריית תמונות</h2>

      <!-- Add New Gallery Image -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">קישור לתמונה</label>
          <input type="url" class="form-input" [(ngModel)]="newGalleryImage.imageUrl" name="newGalleryImageUrl"
            placeholder="https://...">
        </div>

        <div class="form-group">
          <label class="form-label">כיתוב (אופציונלי)</label>
          <input type="text" class="form-input" [(ngModel)]="newGalleryImage.caption" name="newGalleryCaption"
            placeholder="כיתוב לתמונה...">
        </div>
      </div>

      <div class="form-row">
        <button type="button" class="btn-add-gallery" (click)="addGalleryImage()">
          <span class="material-icons">add_photo_alternate</span>
          הוסף לגלריה
        </button>
      </div>

      <!-- Gallery Images List -->
      <div *ngIf="article.galleryImages && article.galleryImages.length > 0" class="gallery-list">
        <div *ngFor="let image of article.galleryImages; let i = index" class="gallery-item">
          <div class="gallery-item-preview">
            <img [src]="image.imageUrl" [alt]="image.caption || 'תמונה בגלריה'">
          </div>

          <div class="gallery-item-info">
            <div class="gallery-item-caption">{{ image.caption || 'ללא כיתוב' }}</div>
            <div class="gallery-item-url">{{ image.imageUrl }}</div>
          </div>

          <div class="gallery-item-actions">
            <button type="button" class="btn-gallery-action" (click)="moveGalleryImageUp(i)" [disabled]="i === 0"
              title="הזז למעלה">
              <span class="material-icons">arrow_upward</span>
            </button>
            <button type="button" class="btn-gallery-action" (click)="moveGalleryImageDown(i)"
              [disabled]="i === article.galleryImages.length - 1" title="הזז למטה">
              <span class="material-icons">arrow_downward</span>
            </button>
            <button type="button" class="btn-gallery-action btn-delete" (click)="removeGalleryImage(i)" title="מחק">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="!article.galleryImages || article.galleryImages.length === 0" class="gallery-empty">
        <span class="material-icons">photo_library</span>
        <p>הגלריה ריקה. הוסף תמונות למאמר.</p>
      </div>
    </div>

    <!-- Publishing Section -->
    <div class="form-section">
      <h2 class="section-title">פרסום</h2>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label required">סטטוס</label>
          <select class="form-select" [(ngModel)]="article.status" name="status" required>
            <option [ngValue]="ArticleStatus.Draft">טיוטה</option>
            <option [ngValue]="ArticleStatus.Published">פורסם</option>
            <option [ngValue]="ArticleStatus.Scheduled">מתוזמן</option>
            <option [ngValue]="ArticleStatus.Archived">ארכיון</option>
          </select>
        </div>

        <div class="form-group" *ngIf="article.status === ArticleStatus.Scheduled">
          <label class="form-label">תאריך תזמון</label>
          <input type="datetime-local" class="form-input" [(ngModel)]="article.scheduledDate" name="scheduledDate">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="article.isFeatured" name="isFeatured">
            <span>⭐ כתבה מומלצת (להצגה בדף הראשי)</span>
          </label>
        </div>

        <div class="form-group" *ngIf="article.isFeatured">
          <label class="form-label">סדר תצוגה</label>
          <input type="number" class="form-input" [(ngModel)]="article.displayOrder" name="displayOrder" min="0"
            placeholder="0">
          <div class="field-hint">ככל שהמספר נמוך יותר, הכתבה תופיע גבוה יותר</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="article.isPremium" name="isPremium">
            <span>👑 כתבה למנויים בלבד</span>
          </label>
        </div>
      </div>
    </div>

    <!-- URL & SEO Section -->
    <div class="form-section">
      <h2 class="section-title">כתובת URL ו-SEO</h2>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label required">Slug (כתובת URL)</label>
          <input type="text" class="form-input slug-input" [(ngModel)]="article.slug" name="slug"
            placeholder="article-slug" required>
          <div class="field-hint">
            הכתבה תהיה זמינה ב: /articles/{{ article.slug || 'slug' }}
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">Canonical URL</label>
          <input type="url" class="form-input" [(ngModel)]="article.canonicalUrl" name="canonicalUrl"
            placeholder="https://...">
          <div class="field-hint">לשימוש אם התוכן מקורי ממקור אחר</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">Meta Title</label>
          <input type="text" class="form-input" [(ngModel)]="article.metaTitle" name="metaTitle"
            placeholder="כותרת לגוגל..." maxlength="250">
          <div class="field-hint">{{ article.metaTitle?.length || 0 }}/250 תווים</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">Meta Description</label>
          <textarea class="form-textarea" [(ngModel)]="article.metaDescription" name="metaDescription" rows="3"
            placeholder="תיאור לתוצאות גוגל..." maxlength="500"></textarea>
          <div class="field-hint">{{ article.metaDescription?.length || 0 }}/500 תווים</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">Open Graph Image (URL)</label>
          <input type="url" class="form-input" [(ngModel)]="article.openGraphImageUrl" name="openGraphImageUrl"
            placeholder="https://...">
          <div class="field-hint">תמונה לשיתוף ברשתות חברתיות (פייסבוק, וואטסאפ)</div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="goBack()" [disabled]="saving">
        ביטול
      </button>
      <button type="submit" class="btn-primary" [disabled]="saving">
        <span *ngIf="!saving">{{ isEditMode ? 'עדכן כתבה' : 'צור כתבה' }}</span>
        <span *ngIf="saving">שומר...</span>
      </button>
    </div>
  </form>
</div>