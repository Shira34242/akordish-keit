<div class="song-page-container" *ngIf="song; else loadingOrError">

    <!-- Copy Notification Toast -->
    <div class="copy-notification" [class.show]="showCopyNotification">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 6 9 17l-5-5"></path>
        </svg>
        הקישור הועתק!
    </div>

    <!-- 1. Top Header Section -->
    <div class="song-header">
        <div class="header-content">

            <!-- Image Section -->
            <div class="header-image-section">
                <div class="song-cover-wrapper">
                    <a [href]="song.youtubeUrl" target="_blank" *ngIf="song.youtubeUrl" class="song-cover-link">
                        <img [src]="song.imageUrl || 'assets/default-song.png'" alt="Cover" class="song-cover"
                            (error)="handleImageError($event)">
                    </a>
                    <img *ngIf="!song.youtubeUrl" [src]="song.imageUrl || 'assets/default-song.png'" alt="Cover" class="song-cover"
                        (error)="handleImageError($event)">
                    <a [href]="song.youtubeUrl" target="_blank" class="youtube-play-btn" *ngIf="song.youtubeUrl">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </a>
                    <a [href]="song.spotifyUrl" target="_blank" class="spotify-play-btn" *ngIf="song.spotifyUrl">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Info Section -->
            <div class="header-info-section">
                <p class="header-subtitle">אקורדים לשיר</p>
                <h1 class="main-title">{{ song.title }}</h1>
                <h2 class="artist-name" (click)="navigateToArtist(song.artists[0]?.id)">{{ song.artists[0]?.name }}</h2>

                <div class="credits" *ngIf="song.composer || song.lyricist">
                    <span *ngIf="song.lyricist">מילים: {{ song.lyricist.name }}</span>
                    <span *ngIf="song.lyricist && song.composer"> | </span>
                    <span *ngIf="song.composer">לחן: {{ song.composer.name }}</span>
                </div>

                <div class="header-meta">
                    <div class="meta-item">
                        <span class="meta-label">סולם מקורי:</span>
                        <span dir="ltr">{{ song.originalKeyName || 'לא ידוע' }}</span>
                    </div>
                    <!-- <div class="meta-item">
                        <span class="meta-label">צפיות:</span>
                        <span>{{ song.viewCount }}</span>
                    </div> -->
                    <div class="meta-item">
                        <span class="meta-label">נוסף ב:</span>
                        <span>{{ song.createdAt | date:'d.M.yyyy' }}</span>
                    </div>
                </div>

                <div class="header-actions">
                    <button class="action-btn btn-bookmark" title="הוסף לרשימה" (click)="togglePlaylistPopup()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path>
                        </svg>
                    </button>
                    <button class="action-btn btn-share" title="שתף" (click)="handleShare()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line>
                            <line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line>
                        </svg>
                    </button>
                    <button class="action-btn btn-print" title="הדפס" (click)="handlePrint()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"></path>
                            <rect x="6" y="14" width="12" height="8" rx="1"></rect>
                        </svg>
                    </button>
                    <button class="action-btn btn-report" title="דווח על טעות" (click)="openReportModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path>
                            <path d="M12 9v4"></path>
                            <path d="M12 17h.01"></path>
                        </svg>
                    </button>
                    <!-- Edit Button - Only for authorized users -->
                    <button class="action-btn btn-edit" title="ערוך שיר" *ngIf="canEdit" (click)="openEditModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                            <path d="m15 5 4 4"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
<div class="content-wrapper">

    <!-- 2. Sticky Toolbar -->
    <div class="sticky-toolbar" [class.sticky]="isToolbarSticky">
        <div class="toolbar-content">

            <!-- Instruments & Chords -->
            <button class="toolbar-btn" [class.active]="selectedInstrument === 'guitar'"
                (click)="selectInstrument('guitar')" title="גיטרה">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m11.9 12.1 4.514-4.514"></path>
                    <path
                        d="M20.1 2.3a1 1 0 0 0-1.4 0l-1.114 1.114A2 2 0 0 0 17 4.828v1.344a2 2 0 0 1-.586 1.414A2 2 0 0 1 17.828 7h1.344a2 2 0 0 0 1.414-.586L21.7 5.3a1 1 0 0 0 0-1.4z">
                    </path>
                    <path d="m6 16 2 2"></path>
                    <path
                        d="M8.2 9.9C8.7 8.8 9.8 8 11 8c2.8 0 5 2.2 5 5 0 1.2-.8 2.3-1.9 2.8l-.9.4A2 2 0 0 0 12 18a4 4 0 0 1-4 4c-3.3 0-6-2.7-6-6a4 4 0 0 1 4-4 2 2 0 0 0 1.8-1.2z">
                    </path>
                    <circle cx="11.5" cy="12.5" r=".5" fill="currentColor"></circle>
                </svg>
            </button>
            <button class="toolbar-btn" [class.active]="selectedInstrument === 'piano'"
                (click)="selectInstrument('piano')" title="פסנתר">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M18.5 8c-1.4 0-2.6-.8-3.2-2A6.87 6.87 0 0 0 2 9v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8.5C22 9.6 20.4 8 18.5 8">
                    </path>
                    <path d="M2 14h20"></path>
                    <path d="M6 14v4"></path>
                    <path d="M10 14v4"></path>
                    <path d="M14 14v4"></path>
                    <path d="M18 14v4"></path>
                </svg>
            </button>
            <button class="toolbar-btn" [class.active]="selectedInstrument === 'lyrics'"
                (click)="selectInstrument('lyrics')" title="מילים בלבד">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                    <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
                    <path d="M10 9H8"></path>
                    <path d="M16 13H8"></path>
                    <path d="M16 17H8"></path>
                </svg>
            </button>

            <div class="toolbar-divider"></div>

            <!-- Transpose with Key Display FIRST -->
            <div class="transpose-group">
                <!-- Current Key Display -->
                <span class="text-sm text-gray-600 px-2 whitespace-nowrap font-medium">{{ currentKey }}</span>

                <!-- Transpose Down -->
                <button class="toolbar-btn" (click)="transpose(-1)" title="הורד חצי טון">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                    </svg>
                </button>

                <!-- Transpose Value -->
                <span class="transpose-val" dir="ltr">{{ transposeDisplay }}</span>

                <!-- Transpose Up -->
                <button class="toolbar-btn" (click)="transpose(1)" title="העלה חצי טון">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                        <path d="M12 5v14"></path>
                    </svg>
                </button>

                <!-- Reset Button -->
                <button class="toolbar-btn toolbar-btn-reset" (click)="resetTranspose()" title="אפס טרנספוזיציה"
                    *ngIf="transposeStep !== 0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Easy Version -->
            <button class="toolbar-btn btn-easy btn-text" 
                    *ngIf="song.easyKeyId" 
                    [class.active]="isEasyMode"
                    (click)="toggleEasyMode()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-left: 4px;">
                    <path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"></path>
                </svg>
                {{ isEasyMode ? 'סולם מקורי' : 'גרסה קלה' }}
            </button>
            <div class="toolbar-divider" *ngIf="song.easyKeyId"></div>

            <!-- Font Size -->
            <button class="toolbar-btn btn-text" (click)="changeFontSize(-1)" title="הקטן טקסט">A-</button>
            <button class="toolbar-btn btn-text" (click)="changeFontSize(1)" title="הגדל טקסט">A+</button>

            <div class="toolbar-divider"></div>

            <!-- Auto Scroll - Show button when NOT scrolling, show controls when scrolling -->
            <button *ngIf="!isAutoScroll" class="toolbar-btn btn-scroll btn-text" (click)="toggleAutoScroll()">
                <span class="text-xs whitespace-nowrap">גלילה אוטומטית</span>
            </button>

            <!-- Auto Scroll Speed Controls (shown when active) -->
            <div class="autoscroll-controls" *ngIf="isAutoScroll">
                <button class="toolbar-btn toolbar-btn-sm" (click)="changeScrollSpeed(-1)" title="האט">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                    </svg>
                </button>
                <span class="scroll-speed-display">{{ scrollSpeed }}</span>
                <button class="toolbar-btn toolbar-btn-sm" (click)="changeScrollSpeed(1)" title="האץ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                        <path d="M12 5v14"></path>
                    </svg>
                </button>
                <button class="toolbar-btn toolbar-btn-sm btn-stop" (click)="toggleAutoScroll()" title="עצור">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Dark Mode Toggle with Dynamic Icon -->
            <button class="toolbar-btn" (click)="toggleTheme()" [title]="isDarkMode ? 'מצב יום' : 'מצב לילה'">
                <!-- Moon Icon (when light mode is active) -->
                <svg *ngIf="!isDarkMode" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                </svg>
                <!-- Sun Icon (when dark mode is active) -->
                <svg *ngIf="isDarkMode" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="4"></circle>
                    <path d="M12 2v2"></path>
                    <path d="M12 20v2"></path>
                    <path d="m4.93 4.93 1.41 1.41"></path>
                    <path d="m17.66 17.66 1.41 1.41"></path>
                    <path d="M2 12h2"></path>
                    <path d="M20 12h2"></path>
                    <path d="m6.34 17.66-1.41 1.41"></path>
                    <path d="m19.07 4.93-1.41 1.41"></path>
                </svg>
            </button>

        </div>
    </div>

    <!-- 3. Main Content Grid -->
    <div class="main-layout">

        <!-- Right Column: Lyrics -->
        <div class="lyrics-column" [class.dark-mode]="isDarkMode" [style.fontSize.px]="fontSize"
            [style.--lyrics-font-size.px]="fontSize">
            <div class="lyrics-content" [innerHTML]="formattedLyricsHtml" (mouseover)="handleLyricsMouseOver($event)"
                (mouseout)="handleLyricsLeave()">
            </div>

            <!-- Chord Tooltip -->
            <app-chord-tooltip *ngIf="hoveredChord" [chordName]="hoveredChord" [instrument]="selectedInstrument === 'lyrics' ? 'guitar' : selectedInstrument"
                [style.position]="'fixed'" [style.left.px]="tooltipPosition.x" [style.top.px]="tooltipPosition.y"
                [style.transform]="'translate(-50%, -110%)'" [style.zIndex]="1000">
            </app-chord-tooltip>
        </div>
        <!-- Left Column: Sidebar -->
        <div class="sidebar-column">
            
            <!-- שירים נוספים של האמן -->
            <div class="sidebar-card artist-card">
                <h3>עוד אקורדים לשירים של {{ song.artists[0]?.name }}:</h3>
                
                <div *ngIf="isLoadingArtistSongs" class="loading-small">טוען...</div>
                
                <ul class="song-list" *ngIf="!isLoadingArtistSongs">
                    <li *ngFor="let artistSong of artistSongs" 
                        [class.current]="artistSong.id === songId"
                        (click)="navigateToSong(artistSong.id)">
                        {{ artistSong.title }}
                    </li>
                    <li *ngIf="artistSongs.length === 0" class="no-songs">
                        אין שירים נוספים
                    </li>
                </ul>
            </div>

            <!-- הכי נצפים השבוע -->
            <div class="sidebar-card popular-card">
                <h3>הכי נצפים השבוע</h3>
                
                <div *ngIf="isLoadingPopularSongs" class="loading-small">טוען...</div>
                
                <ul class="song-list" *ngIf="!isLoadingPopularSongs">
                    <li *ngFor="let popSong of popularSongs; let i = index" 
                        [class.current]="popSong.id === songId"
                        (click)="navigateToSong(popSong.id)">
                        <span class="rank">{{ i + 1 }}</span>
                        {{ popSong.title }}
                    </li>
                </ul>
            </div>

        </div>

    </div>
</div>

</div>

<ng-template #loadingOrError>
    <div class="loading-container" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>טוען שיר...</p>
    </div>
    <div class="error-container" *ngIf="error">
        <p>{{ error }}</p>
        <button (click)="loadSong(songId!)">נסה שוב</button>
    </div>
</ng-template>
<app-add-song-modal
    *ngIf="isEditModalOpen"
    [editMode]="true"
    [songToEdit]="song"
    (close)="closeEditModal()"
    (songAdded)="onSongUpdated()">
</app-add-song-modal>

<!-- Playlist Popup -->
<app-playlist-popup
    *ngIf="isPlaylistPopupOpen && songId"
    [songId]="songId"
    (close)="closePlaylistPopup()">
</app-playlist-popup>

<!-- Report Modal -->
<app-report-modal
    [isOpen]="isReportModalOpen"
    [contentType]="'Song'"
    [contentId]="songId || 0"
    [contentTitle]="song?.title"
    (close)="closeReportModal()">
</app-report-modal>
